{% extends 'core/index.html' %}
{% load static %}



{% block head %}
    <script src="https://api-maps.yandex.ru/2.1/?apikey=–í26b914ca-5401-44b0-b136-b7d9c35bb1a8&lang=ru_RU"
            type="text/javascript"></script>
    <script src="https://unpkg.com/@vkid/sdk@latest/dist-sdk/umd/index.js"></script>
    <script src="{% static 'auth_vk/js/auth_vk.js' %}"></script>
    <script src="{% static 'map_manager/js/renderPlaces.js' %}"></script>
    <script src="{% static 'map_manager/js/formManager.js' %}"></script>
    <script>
        function createPlaceMark(coords, coord1Node, coord2Node) {
            /**
             * —Å–æ–∑–¥–∞–Ω–∏–µ –±–∞–ª—É–Ω–∞ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
             * @type {ymaps.Placemark}
             */
            const placeMark = new ymaps.Placemark(coords, {
                iconContent: '–î–≤–∏–≥–∞–π –º–µ–Ω—è',
            }, {
                balloonPanelMaxMapArea: 0,
                draggable: "true",
                preset: "islands#blueStretchyIcon",
            })

            placeMark.events.add('dragend', function (e) {
                let coords = placeMark.geometry.getCoordinates();
                movePlaceMarkAndRenderCoord(coords, placeMark, coord1Node, coord2Node)
            })
            return placeMark
        }


        function movePlaceMarkAndRenderCoord(coords, placeMark, coord1Node, coord2Node) {
            mapWithPlaces.panTo(coords, {duration: 500});
            placeMark.geometry.setCoordinates(coords);
            coord1Node.value = coords[0]
            coord2Node.value = coords[1]
        }

        function initMap(mapId, balunCoords, coord1Node, coord2Node) {
            /**
             * –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç –∫–∞—Ä—Ç—É —Å –±–∞–ª—É–Ω–æ–º –Ω–∞ –º–µ—Å—Ç–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ –¥–≤–∏–≥–∞—Ç—å
             * –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–∞–º—è—Ç—å –Ω–æ–≤—ã–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
             */
            ymaps.ready(() => {
                const editMap = new ymaps.Map(mapId, {
                    center: [55.76, 37.64],
                    zoom: 5
                });
                const placeMark = createPlaceMark(balunCoords, coord1Node, coord2Node)
                editMap.geoObjects.add(placeMark);

                editMap.events.add('click', function (e) {
                    let coords = e.get('coords');
                    movePlaceMarkAndRenderCoord(coords, placeMark, coord1Node, coord2Node)
                });
            });
        }

        function handleEditClick(e) {
            /**
             * –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É —Ä–µ–¥–∞—á–∏—Ç—å –ø–æ—è–≤–ª—è–µ—Ç—Å—è –∫–∞—Ä—Ç–∞, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–π –º–æ–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å
             * –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –º–µ—Ç–∫–∏ –∏ –ø–æ–º–µ–Ω—è—Ç—å –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–æ–ª—è (–∫—Ä–æ–º–µ –∫–∞—Ä—Ç–∏–Ω–∫–∏)
             */
            e.preventDefault()
            const parentForm = e.target.parentNode.parentNode
            const submitButton = parentForm.querySelector('.places-column__save-button')
            const coordsBlock = parentForm.querySelector('.places-column__coords-manager')
            const editMap = parentForm.querySelector('.memory-manager__map')
            const coord1Node = parentForm.querySelector('.places-column__coords1')
            const coord2Node = parentForm.querySelector('.places-column__coords2')
            if (coordsBlock.style.display !== 'block') {
                // –ï—Å–ª–∏ –º–µ–Ω—é—à–∫–∞ –±—ã–ª–∞ –∑–∞–∫—Ä—ã—Ç–∞
                coordsBlock.style.display = 'block'
                submitButton.style.display = 'block'
                let coords = [parseFloat(coord1Node.value), parseFloat(coord2Node.value)]
                initMap(editMap.id, coords, coord1Node, coord2Node)

                const inputTitle = parentForm.querySelector('.places-column__tittle')
                const inputContent = parentForm.querySelector('.places-column__content')
                inputTitle.removeAttribute('readonly')
                inputContent.removeAttribute('readonly')
            }

        }

        document.addEventListener('DOMContentLoaded', () => {
            /**
             * –î–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–æ–ø–∫–∏ —ç–¥–∏—Ç–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è
             * –∏ —Å–∫—Ä—ã–≤–∞–µ—Ç –º–µ–Ω—é —ç–¥–∏—Ç–∞ (–∏–∑ –∫–∞—Ä—Ç—ã –∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç)
             */
            let editButtonList = document.querySelectorAll('.places-column__edit-button')
            editButtonList.forEach((item) => {
                const parentForm = item.parentNode.parentNode
                const submitButton = parentForm.querySelector('.places-column__save-button')
                const coordsBlock = parentForm.querySelector('.places-column__coords-manager')

                coordsBlock.style.display = 'none'
                submitButton.style.display = 'none'
                item.addEventListener('click', handleEditClick)
            })

        })

    </script>
    <link rel="stylesheet" href="{% static 'map_manager/css/map.css' %}?={{ rand_num }}">
{% endblock %}
<body>

{% block content %}
    <div class="error_message">
        <button class="error_message__close-button">X</button>
        <span>        –ù–µ –∑–∞–±—É–¥—å –¥–æ–±–∞–≤–∏—Ç—å –≥–µ–æ–ø–æ–∑–∏—Ü–∏—é –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è) –°–¥–µ–ª–∞—Ç—å —ç—Ç–æ –º–æ–∂–Ω–æ
        –Ω–∞–∂–∞–≤ –Ω–∞ –∫–∞—Ä—Ç—É –∏ –ø–µ—Ä–µ–º–µ—â–∞—é —Ç–æ—á–∫—É</span>

    </div>
    <div class="content">
        <div class="places-column">
            <div id="firs-el"></div>
            <div class="places-column__item" id="inputForm">
                <button class="close-button">
                    X
                </button>
                <form class="input-form" action="{% url 'map_manager:test' %}" method="post"
                      enctype="multipart/form-data">
                    {% csrf_token %}

                    <div class="input-form__item">
                        <div class="input-form__tittle">
                            –ù–∞–∑–≤–∞–Ω–∏–µ (–º–∞–∫—Å 100 —Å–∏–º–≤–æ–ª–æ–≤)
                        </div>
                        <label>
                            <input required maxlength="100" name="title" type="text"
                                   placeholder="–ñ–æ—Å–∫–∏–π –∫–æ–Ω—Ü–µ—Ä—Ç —Å–∞–±–∞—Ç–æ–Ω–∞...">
                        </label>
                    </div>

                    <div class="input-form__item">
                        <div class="input-form__tittle">
                            –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
                        </div>
                        <label>
                            <textarea placeholder="–°–ª–æ–≤–µ—Å–Ω–æ –Ω–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –ª–∏—Ä–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è"
                                      name="content" cols="40" rows="10" required id="id_content"></textarea>
                        </label>
                    </div>

                    <div class="input-form__item">
                        <div class="input-form__tittle">
                            –ö–∞—Ä—Ç–∏–Ω–∫–∞
                        </div>
                        <label>
                            <input type="file" name="image" accept="image/*" id="id_image">
                        </label>
                    </div>

                    <div class="input-form__item">
                        <div class="input-form__tittle">
                            –ì–µ–æ–ø–æ–∑–∏—Ü–∏—è –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
                        </div>
                        (–∂–º—è–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç—É)
                        <label>
                            <input readonly step="any" class="input-form__coords1" type="number" name="coord1"
                                   id="id_coord1">
                            <input readonly step="any" class="input-form__coords2" type="number" name="coord2"
                                   id="id_coord2">
                        </label>
                        <div class="memory-manager__map" id="formMap" style="width: 90%; height: 400px;"></div>
                    </div>
                    <button class="input-form__submit-button" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </form>
            </div>


            {% if memory_list %}
                {% for memory in memory_list %}
                    <form class="places-column__item" id="memories_{{ memory.pk }}" method="post"
                          action="{% url 'map_manager:update_memories' id=memory.pk %}">
                        {% csrf_token %}
                        <div class="places-column__action-menu">
                            <button class="places-column__edit-button">
                                ‚úèÔ∏è
                            </button>
                            {#                            <button class="places-column__delete-button">#}
                            {#                                üóëÔ∏è#}
                            {#                            </button>#}
                        </div>
                        <label>
                            <input readonly class="places-column__tittle" required maxlength="100" name="title"
                                   type="text"
                                   value="{{ memory.title }}">
                        </label>
                        <div class="places-column__img">
                            {% if memory.image %}
                                <img class="places-column__img-item" src="{{ memory.image.url }}" alt="">
                            {% endif %}
                        </div>
                        <label>
                            <input readonly class="places-column__content" required maxlength="100" name="content"
                                   type="text"
                                   value="{{ memory.content }}">
                        </label>

                        <div class="places-column__coords-manager">
                            <div class="places-column__tittle">
                                –ì–µ–æ–ø–æ–∑–∏—Ü–∏—è –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
                            </div>
                            (–∂–º—è–∫–Ω–∏ –Ω–∞ –∫–∞—Ä—Ç—É)
                            <label>
                                <input readonly value="{{ memory.coord1 }}" step="any" class="places-column__coords1"
                                       type="number" name="coord1">
                                <input readonly value="{{ memory.coord2 }}" step="any" class="places-column__coords2"
                                       type="number" name="coord2">
                            </label>
                            <div class="memory-manager__map" id="editMap_{{ memory.pk }}"
                                 style="width: 90%; height: 400px;"></div>
                        </div>

                        <button class="places-column__save-button" type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    </form>
                {% endfor %}

            {% else %}
                <div class="places-column__item">
                    <div class="places-column__tittle">
                        ‚Äú–£ –≤–∞—Å –Ω–µ—Ç –Ω–∏ –æ–¥–Ω–æ–≥–æ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
                    </div>
                    <div class="places-column__img">
                        <img src="" alt="">
                    </div>
                    <div class="places-column__content">
                        –ú–µ—Å—Ç–æ –¥–ª—è –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ–≥–æ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏—è
                    </div>
                </div>
            {% endif %}
        </div>

        {% if request.user.is_authenticated %}
            <div class="memory-manager">
                <button id="new-memories-button" class="memory-manager__action-button">
                    –î–æ–±–∞–≤–∏—Ç—å –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ
                </button>
                <div class="memory-manager__map" id="mapWithPlaces" style="width: 90%; height: 400px;"></div>
            </div>
        {% else %}
            <div class="memory-manager">
                <div class="memory-manager__action-button">
                    –•–æ—á–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–µ –≤–æ—Å–ø–æ–º–∏–Ω–∞–Ω–∏–µ? –¢–æ–≥–¥–∞ –∂–º—è–∫–∞–π –ø–æ –∫–Ω–æ–ø–∫–µ —Å–Ω–∏–∑—É
                    <div id="VkIdSdkOneTap"></div>
                </div>
                <div class="memory-manager__map" id="mapWithPlaces" style="width: 90%; height: 400px;"></div>
            </div>
        {% endif %}
    </div>
{% endblock %}


